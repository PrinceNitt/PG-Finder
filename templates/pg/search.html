{% extends "base.html" %}

{% block title %}Search PGs - PG Assistant{% endblock %}

{% block content %}
<!-- Navbar -->
<nav class="bg-blue-600 text-white px-6 py-4 shadow-lg">
  <div class="container mx-auto flex justify-between items-center">
    <div class="text-2xl font-bold">PG Assistant</div>
    <div class="space-x-4">
      <a href="/" class="hover:text-gray-200">Home</a>
      <a href="/pg/search" class="hover:text-gray-200">Search PGs</a>
      {% if user_logged_in %}
        {% if user_role == 'pg_owner' %}
          <a href="/pg/my-listings" class="hover:text-gray-200">My Listings</a>
        {% elif user_role == 'student' %}
          <a href="/requests/my-requests" class="hover:text-gray-200">My Requests</a>
        {% endif %}
        <a href="/dashboard" class="hover:text-gray-200">Dashboard</a>
        <a href="/logout" class="bg-red-500 hover:bg-red-600 px-3 py-1 rounded">Logout</a>
      {% else %}
        <a href="/login" class="bg-green-500 hover:bg-green-600 px-3 py-1 rounded">Login</a>
      {% endif %}
    </div>
  </div>
</nav>

<div class="container mx-auto px-4 py-8">
  <h1 class="text-4xl font-bold text-gray-800 mb-6">Search PG Accommodations</h1>
  
  <!-- Search Filters -->
  <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
    <form action="/pg/search" method="GET" class="grid grid-cols-1 md:grid-cols-5 gap-4">
      <input type="text" name="city" placeholder="City" value="{{ search_params.city }}" 
             class="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
      <input type="number" name="min_rent" placeholder="Min Rent (‚Çπ)" value="{{ search_params.min_rent }}" 
             class="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
      <input type="number" name="max_rent" placeholder="Max Rent (‚Çπ)" value="{{ search_params.max_rent }}" 
             class="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
      <input type="text" name="nearby_college" placeholder="Nearby College" value="{{ search_params.nearby_college }}" 
             class="p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
      <button type="submit" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700">
        Search
      </button>
    </form>
    
    <!-- Facilities Filter -->
    {% if all_facilities %}
    <div class="mt-4">
      <label class="block text-gray-700 font-semibold mb-2">Facilities:</label>
      <div class="flex flex-wrap gap-2">
        {% for facility in all_facilities %}
        <label class="flex items-center space-x-2 cursor-pointer">
          <input type="checkbox" name="facilities" value="{{ facility }}" 
                 {% if facility in search_params.facilities %}checked{% endif %}
                 class="facility-checkbox">
          <span class="bg-gray-100 px-3 py-1 rounded hover:bg-gray-200">{{ facility }}</span>
        </label>
        {% endfor %}
      </div>
    </div>
    {% endif %}
  </div>
  
  <!-- Results -->
  <div class="mb-4">
    <p class="text-gray-600">Found <strong>{{ pgs|length }}</strong> PG{{ 's' if pgs|length != 1 else '' }}</p>
  </div>
  
  {% if pgs %}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {% for pg in pgs %}
      <div class="bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition">
        <div class="p-6">
          <h3 class="text-xl font-bold mb-2">{{ pg.name }}</h3>
          <p class="text-gray-600 mb-2">üìç {{ pg.address }}, {{ pg.city }}</p>
          <p class="text-2xl font-bold text-blue-600 mb-2">‚Çπ{{ pg.rent }}/month</p>
          <p class="text-sm text-gray-500 mb-2">Deposit: ‚Çπ{{ pg.deposit }}</p>
          <p class="text-sm text-green-600 font-semibold mb-3">{{ pg.available_rooms }} room{{ 's' if pg.available_rooms != 1 else '' }} available</p>
          
          {% if pg.facilities %}
          <div class="flex flex-wrap gap-2 mb-4">
            {% for facility in pg.facilities[:5] %}
            <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">{{ facility }}</span>
            {% endfor %}
            {% if pg.facilities|length > 5 %}
            <span class="text-xs text-gray-500">+{{ pg.facilities|length - 5 }} more</span>
            {% endif %}
          </div>
          {% endif %}
          
          <a href="/pg/{{ pg._id }}" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 inline-block w-full text-center">
            View Details
          </a>
        </div>
      </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="bg-white rounded-lg shadow-lg p-12 text-center">
      <p class="text-gray-600 text-xl mb-4">No PGs found matching your criteria.</p>
      <a href="/pg/search" class="text-blue-600 hover:underline">Clear filters and search again</a>
    </div>
  {% endif %}
</div>

<script>
// Handle facility checkboxes
document.querySelectorAll('.facility-checkbox').forEach(checkbox => {
  checkbox.addEventListener('change', function() {
    const form = this.closest('form');
    const facilities = Array.from(document.querySelectorAll('.facility-checkbox:checked')).map(cb => cb.value);
    
    // Update form with selected facilities
    facilities.forEach(facility => {
      if (!form.querySelector(`input[name="facilities"][value="${facility}"]`)) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'facilities';
        input.value = facility;
        form.appendChild(input);
      }
    });
    
    // Remove unchecked facilities
    document.querySelectorAll('input[name="facilities"][type="hidden"]').forEach(input => {
      if (!document.querySelector(`.facility-checkbox[value="${input.value}"]:checked`)) {
        input.remove();
      }
    });
  });
});
</script>
{% endblock %}


